import streamlit as st
import random
import matplotlib.pyplot as plt

# âœ… KhÃ³a truy cáº­p
KEY_HOP_LE = "NMTVIP"

def nhap_key():
    st.title("ðŸ” Nháº­p Key Ä‘á»ƒ sá»­ dá»¥ng")
    key_input = st.text_input("Nháº­p key táº¡i Ä‘Ã¢y", type="password")
    if key_input == KEY_HOP_LE:
        return True
    elif key_input:
        st.error("âŒ Key khÃ´ng há»£p lá»‡!")
    return False

def du_doan_xuc_xac(phien):
    s = str(phien)
    so1 = int(s[-3]) % 6 + 1 if len(s) >= 3 else 1
    so2 = int(s[-2]) % 6 + 1 if len(s) >= 2 else 1
    so3 = int(s[-1]) % 6 + 1 if len(s) >= 1 else 1
    return [so1, so2, so3]

# âœ… 8 AI
def AI_A(p, h): return "Xá»‰u" if h.count("tÃ i") > 2 else "TÃ i"
def AI_B(p, h): return "Xá»‰u" if ",".join(h) == "tÃ i,xá»‰u,tÃ i,xá»‰u,tÃ i" else "TÃ i"
def AI_C(p, h=None): return "TÃ i" if p % 2 == 0 else "Xá»‰u"
def AI_D(p, h): return "Xá»‰u" if h.count("tÃ i") > h.count("xá»‰u") else "TÃ i"
def AI_E(p, h): return "TÃ i" if sum(1 for i in range(1, len(h)) if h[i] != h[i-1]) >= 3 else "Xá»‰u"
def AI_F(p, h): return "Xá»‰u" if h.count("tÃ i") / len(h) > 0.5 else "TÃ i"
def AI_G(p, h): return "TÃ i" if (p * 17 + len(h) * 31) % 2 == 0 else "Xá»‰u"
def AI_H(p, h):
    c = 0
    for i in range(len(h)-1, 0, -1):
        if h[i] == h[i-1]:
            c += 1
        else:
            break
    if c >= 2:
        return "Xá»‰u" if h[-1] == "tÃ i" else "TÃ i"
    return "TÃ i" if p % 2 == 0 else "Xá»‰u"

# âœ… 7 thuáº­t toÃ¡n mÃ£ phiÃªn
def taiXiu_CoBan(p):
    so = du_doan_xuc_xac(p)
    tong = sum(so)
    return 'TÃ i' if tong >= 11 else 'Xá»‰u'

def taiXiu_DoanDoChinhXac(p, do_chinh_xac=85):
    kq = taiXiu_CoBan(p)
    return kq if random.randint(0, 100) < do_chinh_xac else ('Xá»‰u' if kq == 'TÃ i' else 'TÃ i')

def taiXiu_TongChia2(p):
    tong = sum(int(c) for c in str(p))
    return 'TÃ i' if tong % 2 == 0 else 'Xá»‰u'

def taiXiu_Chia23(p):
    so = int(str(p)[-4:])
    tong = so % 23
    return 'TÃ i' if tong >= 11 else 'Xá»‰u'

def taiXiu_ViTriChanLe(p):
    s = [int(c) for c in str(p)]
    chan = sum(s[i] for i in range(0, len(s), 2))
    le = sum(s[i] for i in range(1, len(s), 2))
    return 'TÃ i' if abs(chan - le) % 2 == 0 else 'Xá»‰u'

def taiXiu_Mix(p):
    s = str(p)
    tong = sum(int(s[i]) for i in [0,1,2,-1,-2,-3] if i < len(s))
    return 'TÃ i' if tong % 18 >= 10 else 'Xá»‰u'

def taiXiu_DaoMaHoa(p):
    s = str(p)[::-1]
    sum_val = sum(int(c)*(i+1) for i, c in enumerate(s))
    return 'TÃ i' if sum_val % 18 >= 10 else 'Xá»‰u'

def main_tool():
    st.title("ðŸ”® Dá»± Ä‘oÃ¡n TÃ i/Xá»‰u + XÃºc Xáº¯c AI")
    phien = st.number_input("Nháº­p mÃ£ phiÃªn", value=15021)
    soPhien = st.number_input("Sá»‘ phiÃªn muá»‘n dá»± Ä‘oÃ¡n", min_value=1, max_value=100, value=10)

    lichsu = []
    cols = st.columns(5)
    for i in range(5):
        with cols[i]:
            kq = st.selectbox(f"KQ {i+1}", ["TÃ i", "Xá»‰u"])
            lichsu.append(kq.lower())

    if st.button("Dá»± Ä‘oÃ¡n"):
        tai = xiu = 0
        results = []
        data_array = []
        for _ in range(soPhien):
            ai_list = [
                AI_A(phien, lichsu),
                AI_B(phien, lichsu),
                AI_C(phien),
                AI_D(phien, lichsu),
                AI_E(phien, lichsu),
                AI_F(phien, lichsu),
                AI_G(phien, lichsu),
                AI_H(phien, lichsu)
            ]
            code_list = [
                taiXiu_CoBan(phien),
                taiXiu_DoanDoChinhXac(phien),
                taiXiu_TongChia2(phien),
                taiXiu_Chia23(phien),
                taiXiu_ViTriChanLe(phien),
                taiXiu_Mix(phien),
                taiXiu_DaoMaHoa(phien)
            ]

            count = {"TÃ i": 0, "Xá»‰u": 0}
            for kq in ai_list + code_list:
                count[kq] += 1

            final = "TÃ i" if count["TÃ i"] > count["Xá»‰u"] else "Xá»‰u"
            dices = du_doan_xuc_xac(phien)
            tong = sum(dices)
            results.append(f"PhiÃªn {phien} â†’ ðŸŽ² {dices} = {tong} â‡’ âœ… {final}")
            if final == "TÃ i": tai += 1
            else: xiu += 1

            data_array.append(final.lower())
            lichsu.append(final.lower())
            lichsu.pop(0)
            phien += 1

        st.success(f"ðŸ“Š Tá»•ng káº¿t: {tai} TÃ i, {xiu} Xá»‰u")
        st.text("\n".join(results))

        # Biá»ƒu Ä‘á»“
        fig, ax = plt.subplots()
        ax.bar(["TÃ i", "Xá»‰u"], [data_array.count("tÃ i"), data_array.count("xá»‰u")], color=["green", "blue"])
        st.pyplot(fig)

# âœ… Cháº¡y á»©ng dá»¥ng
if __name__ == "__main__":
    if nhap_key():
        main_tool()
